<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width">
    <meta property="og:title" content=" Raku testing and conditional compilation |  CodeSections"> 
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content=" Raku testing and conditional compilation |  CodeSections">
    <meta name="twitter:image:src" content="https://www.codesections.com/codesections_logo.png"> 
    <meta property="og:type" content="article">
    <meta property="og:url" content="www.codesections.com">
    <meta property="og:site_name" content="CodeSections">
    <meta property="article:section" content="Article Section">
    <meta property="og:image" itemprop="image primaryImageOfPage" content="https://www.codesections.com/codesections_logo_large.png"><meta name="og:description" content="The personal website and blog of Daniel Long Sockwell, a lawyer-turned-programmer with an interest in web development, open source, and making things as simple as possible.">
    <meta name="description" content="The personal website and blog of Daniel Long Sockwell, a lawyer-turned-programmer with an interest in web development, open source, and making things as simple as possible.">
    <meta name="twitter:description" content="The personal website and blog of Daniel Long Sockwell, a lawyer-turned-programmer with an interest in web development, open source, and making things as simple as possible.">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/manifest.json">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="theme-color" content="#d9d9d9">
    <link rel="canonical" href="https:&#x2F;&#x2F;www.codesections.com&#x2F;&#x2F;blog&#x2F;raku-unit-testing-with-conditional-compilation">
    <title>
       Raku testing and conditional compilation |  CodeSections 
    </title>
    <style> 
      /*==================================*\
        ##All CSS for this page
      \*==================================*/
      
      /*  Theme colors
       *  #cde     pastel blue (note boxes)
       *  #000     true black (site header)
       *  #4F82BB; Dark Blue  (Nav bar)
       *  #223     near black (text & logo)
       *  #fff     white (menu text)
       *  #07e     sky blue (links)
       *  #dfe2e5  Light grey (tables & borders)
       */
      html {
        font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Oxygen-Sans,
          Ubuntu,Roboto,Cantarell,"Helvetica Neue",sans-serif;
        font-size: 17px;
        color: #223; /*near black*/
      }
      a {
        color: #0071F0; /*sky blue*/
        text-decoration: none;
      }
      .hidden {
        display: none;
      }
      
      .nav-bar {
        position: fixed;
        z-index: 1;
        left: 0;
        width: 100%;
        padding: 0;
        background-color: #4F82BB; /*Dark Blue*/
        box-shadow: 0 3px 6px rgba(0, 0, 0, .3);
        top: 0;
      }
      .nav-bar__container {
        display: flex;
        max-width: 700px; /*max comfortable line length*/
        padding-left: 8px;
        padding-right:8px;
        margin: auto;
        justify-content: space-between;
      }
      .nav-bar__btn {
        position: relative;
        cursor: pointer;
        background-color: inherit;
        height: 1.25em;
        display: inline-block;
      }
      .nav-bar__btn a {
        color: white;
      }
      .nav-bar__btn a:after {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 0;
        content: "";
        transition: all 0.4s ease;
        border-top: 3px solid #223; /*near black*/
      }
      .nav-bar__btn:not(.nav-bar__btn--icon) a:hover:after {
          width: 100%;
      }
      .svg__logo {
        height: 40px;
        width: 40px;
      }
      .svg__logo--background {
        fill: #4F82BB;
      }
      @media (max-width: 599px) { /*Phone only*/
        .nav-bar__btn {
          font-size: 1.382em;
          line-height: 1.382em;
        }
      }
      @media (min-width: 600px) {  /*Tablet-portrait & up*/
        .nav-bar__btn {
          font-size: 2em;
        }
        .svg__logo {
          height: 64px;
          width: 64px;
        }
      }
      
      /*==================================*\
        ##Main content
      \*==================================*/
      .content-main{
        min-height: calc(100vh - 100px - 3em);
        /*  This equals [fullscreen - (top margin) -
         *  (space for the 2-line footer, with margin)]*/
        max-width: 700px; /*  Match nav container width*/
        margin: 3em auto auto auto;
        padding: .1em;
        font-size: 1.15em;
        line-height: 1.6em;
        color: #444;
      }
      .content-main h1 {
        font-size: 1.7em;
        margin-top: .5em;
        margin-bottom: .5em;
        line-height: 1.1em;
      }
      .content-main h2 {
        margin-top: .25em;
      }
      .content-main blockquote {
          
          border-left: #dfe2e5 solid 7px;
          padding-left: .5em;
          padding-right: .5em;
          margin-left: 40px; /* default */
          width: calc(100% - 1em - 40px);
      }
      @media (min-width: 600px) {
        .content-main h2 {
          margin-top: 1em;
        }
      }
      .content-main p {
        margin-bottom: 1.75em;
      }
      .content-main p code,
      .content-main ul code {
        color: #c0341d;
        background-color: #fbe5e1;
        border-radius: 3px;
      }
      .content-main pre {
        overflow-x: auto;
        padding: .5em;
        line-height: 1.3em;
      }
      .content-main img {
        width: 100%;
      }
      .content-main .give-border img {
        border: #dfe2e5 solid 1px;
      }
      .page-nav__earlier {
        float: right;
      }
      .content-main aside {
        background-color: #cde; /* Pastel blue*/
        display: block;
        padding: .75em;
        margin-top: 1em;
        color: #0d1d25; /*near black*/
        border: solid 2px #0d1d25; /* Near black*/
        max-width: 90%;
        margin: auto;
      }
      .content-main aside p:first-child {
        margin-top: 0;
      }
      .content-main aside p:last-child {
        margin-bottom: 0;
      }

      .content-main .highlight {
        background-color: #EFCB68; /* Orange Yellow Crayola */
        font-size: larger;
        display: block;
        padding: .75em;
        margin-top: 1em;
        color: #0d1d25; /*near black*/
        border: solid 2px #0d1d25; /* Near black*/
        border-radius: 7px;
        max-width: 90%;
        margin: auto;
      }
      .content-main .highlight :first-child {
        margin-top: 0;
      }
      .content-main .highlight :last-child {
        margin-bottom: 0;
      }
      
      /*==================================*\
        ##Footer
      \*==================================*/
      .footer {
        margin-top: 2em;
        text-align: center;
      }
      .footer ul {
        margin: 5px;
        padding: 0;
      }
      .footer li {
        display: inline-block;
      }
  
</style>
  </head>

  <body>
    <nav class="nav-bar">
      <ul class="nav-bar__container">
        <li class="nav-bar__btn"><a href="/">Home</a></li>
        <li class="nav-bar__btn"><a href="/contact">Contact</a></li>
        <li class="nav-bar__btn nav-bar__btn--icon">
            <!-- site logo, as an inline SVG because that loads faster-->
            <a href="/"><span class="hidden">Home</span>
            <svg class="svg__logo" viewBox="0 0 100 120" stroke-width="1px"
              stroke="#000" height="100" width="100">
              <title>Logo image/link to homepage</title>
              <circle class="svg__logo--background" fill="#fff"
              stroke="none" cx="50" cy="35" r="69"/>
              <path d="M -9,50 25,10 V 25 L 4,50 25,75 v 15 z"/>
              <path d="m 49,92 c 12,0 20,-8 20,-17 0,-7 -3,-11 -7,-13 5,-3 7,-7
              7,-12 0,-18 -30,-12 -30,-25 3,-11 17,-7 26,-3 l 2,-7 c -13,-7
              -35,-4 -35,11 0,6 3,11 9,14 -5,2 -9,7 -9,13 0,16 29,11 29,24 0,5
              -6,8 -13,8 -6,0 -11,-4 -15,-6 l -2,7 c 5,3 11,6 18,6 z"/>
              <path d="M 110,50 75,90 V 75 L 98,50 75,25 V 10 Z"/>
              <ellipse class="svg__logo--background" ry="8.5" rx="11.5"
              cy="51" cx="50" fill="#fff"/>
            </svg>
            </a>
        </li>
        <li class="nav-bar__btn"><a href="/blog">Blog</a></li>
        <li class="nav-bar__btn"><a href="/projects">Projects</a></li>
      </ul>
    </nav>
    <section class="content-main">
  
    

  <h2>Raku testing and conditional compilation</h2>
  <p>I've been really falling in love with the <a href="https://raku.org">Raku</a>
programming language – it's powerful, expressive, has great support
for introspection, strong pattern matching, and <strong>extremely</strong> good
support for metaprogramming.  I'm pretty much sold on using it for any
project where I don't need raw performance.  (When I do need raw
performance, I still reach for Rust).</p>
<p>That said, there are a few niceties and patterns I miss from Rust.
Fortunately, Raku is powerful enough to make nearly all of them
possible, usually with just a few lines of code.</p>
<p>Today, I'd like to talk about one example: Writing unit tests in the
same file as the code under test, without any runtime cost thanks to
conditional compilation.</p>
<span id="continue-reading"></span><h2 id="organizing-tests">Organizing tests</h2>
<p>Putting code and unit tests together in the same file is generally
<em>not</em> standard procedure in Raku.  Instead, as explained in the <a href="https://docs.raku.org/language/Testing">Test
docs</a>, you typically put all
tests in a <code>/t</code> directory, and name each file with the same name as
the code under test – except with a <code>.t</code> extension instead of a
<code>.rakumod</code> or <code>.pm6</code> extension.  So, if you're testing the code in a
<code>fibonacci.pm6</code> file, you'd put the tests in <code>/t/fibonacci.t</code>.</p>
<p>This <em>works</em>, and if you prefer it, you should certainly feel free to
stick with that method.  It can be a clean way to organize your code,
especially if you tend to write longer modules (which can make the
module+test combination unmanageably large).</p>
<p>On the other hand, I really like <a href="https://doc.rust-lang.org/stable/book/ch11-03-test-organization.html">Rust's approach to organizing unit
tests</a>:
put each test in the same file as the code being tested.  This has a
few pretty large advantages:</p>
<ul>
<li>It's easy to see what tests apply to a function/tell when something
is untested.</li>
<li>Writing tests involves fewer context-switches.</li>
<li>Tests can access private functionality of the module under test
(<a href="https://stackoverflow.com/questions/105007/should-i-test-private-methods-or-only-public-ones">opinions</a> strongly
<a href="https://henrikwarne.com/2014/02/09/unit-testing-private-methods/">differ</a>
about whether testing private methods/functions is good practice.
But, in my experience, at least having the <em>option</em> frequently
helps write simpler code.)</li>
</ul>
<h2 id="the-typical-downsides-of-tests-in-the-same-file">The typical downsides of tests in the same file</h2>
<p>Given these advantages, why do so many languages default to organizing
their tests outside of the file/module/package/namespace containing
the code under test?  In short, performance.</p>
<p>In most interpreted languages (and more than a few compiled ones),
adding test code to the main file would have a significant run-time
cost.  Even if the test code isn't <em>executed</em> at run time, it's still
present in the file; it still needs to be parsed before the program
can be run (or, for a compiled program, it still bloats the binary).</p>
<h4 id="rust-s-solution">Rust's solution</h4>
<p>How does Rust get around this?  As performance-focused as Rust is,
there's no way it would pay a runtime cost for its tests.  And,
indeed, it doesn't: it uses conditional compilation to compile test
code <em>only</em> when running tests.  The standard way to write tests in
Rust looks like this:</p>
<pre style="background-color:#002b36;">
<code><span style="color:#839496;">#</span><span style="color:#657b83;">[</span><span style="color:#268bd2;">cfg</span><span style="color:#657b83;">(</span><span style="color:#839496;">test</span><span style="color:#657b83;">)]
</span><span style="color:#268bd2;">mod </span><span style="color:#b58900;">test </span><span style="color:#657b83;">{
    </span><span style="color:#859900;">use super</span><span style="color:#839496;">::</span><span style="color:#657b83;">*</span><span style="color:#839496;">;
    
    #</span><span style="color:#657b83;">[</span><span style="color:#268bd2;">test</span><span style="color:#657b83;">]
    </span><span style="color:#268bd2;">fn </span><span style="color:#b58900;">first_test</span><span style="color:#657b83;">() {}
}
</span></code></pre>
<p>In case you don't speak Rust, the <code>#[cfg(test)]</code> on the first line is
an attribute that tells the Rust compiler to <em>only</em> compile the
following block when it's running a test.  If you compile that project
without passing the <code>test</code> argument, you'll get <strong>exactly</strong> the same
binary you would have gotten without writing a single line of test
code.  Rust achieves what it's always looking for: the zero-cost
abstraction.</p>
<h4 id="bringing-this-solution-to-raku">Bringing this solution to Raku</h4>
<p>Raku doesn't have conditional compilation in the same way Rust does
(at least not yet, anyway!).  But it <em>does</em> have a sophisticated
notion of compile-time programming that's powerful enough to give us
the equivalent – though, as we'll see, it's <em>so</em> powerful that we'll
have to be careful to get exactly what we want at the truly zero cost
that Rust provides.</p>
<aside>
The next few sections walk through my logic for
how we can bring this functionality to Raku, but the impatient can
<a href="#putting-it-all-together">skip to the bottom</a>.
</aside>
<p>At the most basic level, how can we get started with compile-time
programming in Raku?  Well, we can begin with a
<a href="https://docs.raku.org/language/phasers#BEGIN"><code>BEGIN</code> block</a> (or a
<a href="https://docs.raku.org/language/phasers#CHECK"><code>CHECK</code> block</a>).
Both of these blocks execute code <em>only</em> at compile time, with <code>BEGIN</code>
executing at the beginning of compile time, while <code>CHECK</code> executes at the
end.  So, imagine you have code like this:</p>
<pre style="background-color:#002b36;">
<code><span style="color:#b58900;">CHECK </span><span style="color:#657b83;">{ </span><span style="color:#268bd2;">say </span><span style="color:#839496;">&#39;</span><span style="color:#2aa198;">compiling</span><span style="color:#839496;">&#39; </span><span style="color:#657b83;">}
</span><span style="color:#268bd2;">say </span><span style="color:#839496;">&#39;</span><span style="color:#2aa198;">running</span><span style="color:#839496;">&#39;;
</span></code></pre>
<p>If you invoke this file with <code>raku -c</code>, you'll compile it without
running it, and you'll get &quot;compiling&quot; as your output.  If you run
this file with <code>raku</code>, you'll both compile and run it, and you'll
get both &quot;compiling&quot; and &quot;running&quot; as output.</p>
<aside>
Hold on, <strong>both</strong> compile and run?  Wasn't the whole point of doing
something at compile time to be able to <em>avoid</em> doing it at runtime?
So why are we compiling this file every time we run it?
<p>Because we haven't created a module.  When you write a module, Rakudo
will compile it to bytecode, and will only recompile the bytecode if
the underlying source has changed.  However, when you don't write a
module, Rakudo will re-compile the source each time you run the
program.  We'll shift to using a module for this exact reason in a few
minutes.</p>
</aside>
<h4 id="check-blocks-aren-t-good-enough">CHECK blocks aren't good enough</h4>
<p>Using <code>CHECK</code> blocks, however, won't quite get us where we want to
be.  If you split this out into its own module, and compile it, you'll
notice that it does <em>not</em> produce the same bytecode as the file
without the <code>CHECK</code> block.  That is, this code:</p>
<pre style="background-color:#002b36;">
<code><span style="color:#b58900;">unit module Example</span><span style="color:#839496;">;
</span><span style="color:#268bd2;">say </span><span style="color:#839496;">&#39;</span><span style="color:#2aa198;">running</span><span style="color:#839496;">&#39;;
</span></code></pre>
<p>and this code</p>
<pre style="background-color:#002b36;">
<code><span style="color:#b58900;">unit module Example</span><span style="color:#839496;">;
</span><span style="color:#b58900;">CHECK </span><span style="color:#657b83;">{ </span><span style="color:#268bd2;">say </span><span style="color:#839496;">&#39;</span><span style="color:#2aa198;">compiling</span><span style="color:#839496;">&#39; </span><span style="color:#657b83;">}
</span><span style="color:#268bd2;">say </span><span style="color:#839496;">&#39;</span><span style="color:#2aa198;">running</span><span style="color:#839496;">&#39;;
</span></code></pre>
<p>don't produce the same bytecode.  Specifically, the first version
produces only 24 KiB of bytecode, while the second produces 52 KiB.
For a long time, I couldn't figure out what caused this discrepancy –
but <a href="https://jnthn.net/">Johnathan Worthington</a> was kind enough to
<a href="https://stackoverflow.com/questions/63598552/why-does-non-executed-compile-time-code-increase-rakus-byetcode-size-does-it-s/63599466">explain it to
me</a>:
Raku has the concept of <em>nested</em> compile times and runtimes, which
means that the bytecode needs to include some output for the inner
compile time (even though it doesn't get executed in the run time we
really care about).</p>
<p>Now, this isn't really a big deal at all–as Johnathan also explained,
Rakudo is <em>very</em> good at minimizing the cost of bytecode that's never
run.  But we're going for <strong>zero</strong> cost, so we'll need to do better.</p>
<h4 id="switching-to-doc">Switching to DOC</h4>
<p>The key to doing so lies in the <a href="https://docs.raku.org/language/phasers#DOC_phasers"><code>DOC</code>
block</a> – the block
Raku provides to execute code when generating documentation.  Like the
<code>CHECK</code> and <code>BEGIN</code> phasers, <code>DOC</code> blocks aren't invoked during
runtime; unlike those blocks, <code>DOC</code> blocks avoid creating a nested
runtime inside the compile time.  With that in mind, let's update our
code:</p>
<pre style="background-color:#002b36;">
<code><span style="color:#b58900;">unit module Example</span><span style="color:#839496;">;
</span><span style="color:#cb4b16;">DOC </span><span style="color:#b58900;">CHECK </span><span style="color:#657b83;">{ </span><span style="color:#268bd2;">say </span><span style="color:#839496;">&#39;</span><span style="color:#2aa198;">compiling</span><span style="color:#839496;">&#39; </span><span style="color:#657b83;">}
</span><span style="color:#268bd2;">say </span><span style="color:#839496;">&#39;</span><span style="color:#2aa198;">running</span><span style="color:#839496;">&#39;;
</span></code></pre>
<p>Great, now we're back to the 24 KiB we'd have had without any compile
time code.</p>
<h4 id="using-tests-without-use-test">Using tests without <code>use test</code></h4>
<p>This <em>almost</em> gets us to a perfect solution – but not quite.  If we
add a <code>use Test;</code> line to our code, we're right back to seeing our
bytecode size shoot up (this time, all the way to 88 KiB).  What's going on?</p>
<p>Once again, <a href="https://stackoverflow.com/questions/63598552/why-does-non-executed-compile-time-code-increase-rakus-byetcode-size-does-it-s/63599466">Johnathan had the
answer</a>:</p>
<blockquote>
<p>So far as use goes, its action is performed as soon as it is
parsed. Being inside a DOC CHECK block does not suppress that - and
in general can not, because the use might bring in things that need
to be known in order to finish parsing the contents of that block.</p>
</blockquote>
<p>Ok, so <code>use</code> statements are special and will add to our bytecode even
when they live inside a <code>DOC CHECK</code> block.  How can we fix that? Easy,
just don't use <code>use</code>.  Ok, next question: how can we test anything
without a <code>use Test</code> line?</p>
<p>We can take advantage of another Rakudo option, <code>-M</code>.  This flag
loads a module immediately before running the program – if we invoke
our module with <code>raku -MTest</code>, then we can call all test functions we
want without ever needing to <code>use Test</code>.</p>
<h4 id="compiler-fight">Compiler fight</h4>
<p>So, we have our test code working perfectly, but Rakudo isn't at all
happy with our non-test code.  When we run our code without <code>-MTest</code>,
Rakudo complains that whatever Test functions we're using are
<code>Undeclared routine</code>s – even though they're inside <code>DOC CHECK</code> blocks
and won't get executed.  At this point in figuring this all out, I was
just about ready to swear at Rakudo: yes, the routine is undefined
<em>now</em>, but it won't be when you need to call it!  Grrrrr.</p>
<aside>
I <strong>think</strong> this behavior is a bug – it really seems that
Rakudo shouldn't look for undefined symbols in blocks that it's not
allowed to execute at the moment.  But I'm not <em>quite</em> sure
enough to open an issue on the Rakudo repository.  I'd be very
interested in hearing other's thoughts, though.
</aside>
<p>Fortunately for this blog post and my sanity, Raku offers us an easy
out: to use the <code>is</code> method from <code>Test</code>, we add a single line: <code>multi is(|) { callsame }</code>.  This satisfies Rakudo with a placeholder <code>&amp;is</code>
symbol for the times that we're <em>not</em> loading <code>Test</code>, while still
letting us invoke the <em>actual</em> <code>is</code> function when we have loaded
<code>Test</code>.  (If you haven't come across <code>callsame</code> or the cool things you
can do with it before, then <a href="https://docs.raku.org/language/functions#Re-dispatching">the relevant
docs</a> are
well worth a read.)</p>
<h2 id="putting-it-all-together">Putting it all together</h2>
<p>Despite the length of this post, all of this results in just a few
lines of code.  Here's what testing a simple Fibonacci function would
look like:</p>
<pre style="background-color:#002b36;">
<code><span style="color:#586e75;"># ./bin/fibonacci
</span><span style="color:#cb4b16;">use </span><span style="color:#b58900;">v6d</span><span style="color:#839496;">;
</span><span style="color:#cb4b16;">use </span><span style="color:#b58900;">Fibonacci</span><span style="color:#839496;">;

</span><span style="color:#586e75;">#| Print the first N Fibonacci numbers
</span><span style="color:#859900;">sub </span><span style="color:#b58900;">MAIN</span><span style="color:#657b83;">(</span><span style="background-color:#6e2e32;color:#839496;">Int</span><span style="color:#839496;"> </span><span style="color:#268bd2;">$</span><span style="background-color:#6e2e32;color:#839496;">N</span><span style="color:#657b83;">) { </span><span style="color:#268bd2;">say </span><span style="color:#b58900;">fibonacci</span><span style="color:#657b83;">(</span><span style="color:#859900;">$</span><span style="color:#268bd2;">N</span><span style="color:#657b83;">)</span><span style="color:#859900;">.</span><span style="color:#268bd2;">join</span><span style="color:#657b83;">(</span><span style="color:#839496;">&quot;</span><span style="color:#dc322f;">\n</span><span style="color:#839496;">&quot;</span><span style="color:#657b83;">) }
</span></code></pre><pre style="background-color:#002b36;">
<code><span style="color:#586e75;"># ./lib/Fibonacci.pm6
</span><span style="color:#cb4b16;">use </span><span style="color:#b58900;">v6d</span><span style="color:#839496;">;
</span><span style="color:#b58900;">unit module Fibonacci</span><span style="color:#839496;">;

</span><span style="color:#586e75;">#| Return a list of the first $n Fibonacci numbers
</span><span style="color:#859900;">sub </span><span style="color:#b58900;">fibonacci</span><span style="color:#657b83;">(</span><span style="background-color:#6e2e32;color:#839496;">Int</span><span style="color:#839496;"> </span><span style="color:#268bd2;">$</span><span style="background-color:#6e2e32;color:#839496;">n</span><span style="color:#839496;"> </span><span style="background-color:#6e2e32;color:#839496;">--&gt;</span><span style="color:#839496;"> </span><span style="background-color:#6e2e32;color:#839496;">List</span><span style="color:#657b83;">) </span><span style="background-color:#6e2e32;color:#839496;">is</span><span style="color:#839496;"> </span><span style="background-color:#6e2e32;color:#839496;">export</span><span style="color:#839496;"> </span><span style="color:#657b83;">{ 
    </span><span style="color:#268bd2;">state </span><span style="color:#859900;">@</span><span style="color:#268bd2;">fib </span><span style="color:#657b83;">= </span><span style="color:#6c71c4;">1</span><span style="color:#839496;">, </span><span style="color:#6c71c4;">1</span><span style="color:#839496;">, </span><span style="color:#657b83;">* + *</span><span style="color:#839496;"> … ∞;
    </span><span style="color:#859900;">@</span><span style="color:#268bd2;">fib</span><span style="color:#657b83;">[</span><span style="color:#859900;">^$</span><span style="color:#268bd2;">n</span><span style="color:#657b83;">]
} 

</span><span style="color:#cb4b16;">DOC </span><span style="color:#b58900;">CHECK </span><span style="color:#657b83;">{ </span><span style="color:#b58900;">multi </span><span style="color:#cb4b16;">is</span><span style="color:#657b83;">-</span><span style="color:#b58900;">deeply</span><span style="color:#657b83;">(</span><span style="color:#859900;">|</span><span style="color:#657b83;">) { </span><span style="color:#cb4b16;">callsame </span><span style="color:#657b83;">}
   </span><span style="color:#b58900;">fibonacci</span><span style="color:#657b83;">(</span><span style="color:#6c71c4;">1</span><span style="color:#657b83;">)</span><span style="color:#859900;">.&amp;</span><span style="color:#b58900;">is</span><span style="color:#657b83;">-</span><span style="color:#b58900;">deeply</span><span style="color:#657b83;">((</span><span style="color:#6c71c4;">1</span><span style="color:#839496;">,</span><span style="color:#657b83;">)</span><span style="color:#839496;">, &#39;</span><span style="color:#2aa198;">Fibonacci of 1</span><span style="color:#839496;">&#39;</span><span style="color:#657b83;">)</span><span style="color:#839496;">;
   </span><span style="color:#b58900;">fibonacci</span><span style="color:#657b83;">(</span><span style="color:#6c71c4;">5</span><span style="color:#657b83;">)</span><span style="color:#859900;">.&amp;</span><span style="color:#b58900;">is</span><span style="color:#657b83;">-</span><span style="color:#b58900;">deeply</span><span style="color:#657b83;">((</span><span style="color:#6c71c4;">1</span><span style="color:#839496;">,</span><span style="color:#6c71c4;">1</span><span style="color:#839496;">,</span><span style="color:#6c71c4;">2</span><span style="color:#839496;">,</span><span style="color:#6c71c4;">3</span><span style="color:#839496;">,</span><span style="color:#6c71c4;">5</span><span style="color:#657b83;">)</span><span style="color:#839496;">, &#39;</span><span style="color:#2aa198;">Fibonacci of 5</span><span style="color:#839496;">&#39;</span><span style="color:#657b83;">)</span><span style="color:#839496;">;
</span><span style="color:#657b83;">}
</span></code></pre>
<p>With that code, you can test with <code>raku --doc -c -MTest lib/Fibonacci</code>, which produces</p>
<pre style="background-color:#002b36;">
<code><span style="color:#839496;">ok 1 - Fibonacci of 1
ok 2 - Fibonacci of 2
Syntax OK
</span></code></pre>
<p>And you can run it with <code>raku -Ilib bin/fibonacci</code> which produces</p>
<pre style="background-color:#002b36;">
<code><span style="color:#839496;">Usage:
  bin/fibonacci &lt;N&gt; -- Print the first N Fibonacci numbers
</span></code></pre>
<p>(I still can't get over how easy Raku makes producing nice usage
output!).  Or, for actual output, with <code>raku -Ilib bin/fibonacci 5</code>:</p>
<pre style="background-color:#002b36;">
<code><span style="color:#839496;">1
1
2
3
5
</span></code></pre>
<p>And – perhaps best of all! – our byte code is only 40 KiB.  And that's
<strong>exactly</strong> the same size as if we'd omitted the tests entirely.  A
true zero cost abstraction, in a single line of code.</p>
<h2 id="summing-up">Summing up</h2>
<p>This may not be %100 seamless.  In particular, if your tests use a lot
of functions from <code>Test</code>, declaring the <code>multi</code>s could get annoying.
But, in a single line of code, we were able to build a powerful
feature and one I've been missing from Rust.  And <em>that's</em> a small
taste of what I love so much about Raku.</p>
<p>If you have any thoughts about this post, especially including any
ways to make this even better, I'd love to hear them.  You can email
me, find me on the <a href="https://raku.org/community/irc">#raku IRC
channel</a>, or post to <a href="https://www.reddit.com/r/rakulang/comments/ih8tc9/unit_testing_in_raku_with_conditional_compilation/?">this post's
thread on r/rakulang</a>.</p>



  
</section>
    
  <footer class="footer">
    <ul>
      <li>© 2020 |</li>
      <li><a href="/contact">Contact</a> |</li>
      <li><a href="/license/">Few Rights Reserved</a> |</li>
      <li><a href="/rss.xml" type="application/rss+xml"> RSS</a></li>
    </ul>
    <ul>
      <li><a href="/privacy">Privacy Guarantees</a> |</li>
      <li><a href="https://github.com/codesections-personal/codesections">
        Source Code for codesections.com</a>
      </li>
    </ul>
  </footer>

  
</body>
</html>
